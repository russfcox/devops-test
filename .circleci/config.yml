version: 2.0
jobs:
  build:
    docker:
      - image: docker:17.05.0-ce-git
      # - image: circleci/node:7.10
      #   environment:
      #     DB_HOST: localhost
      #     DB_NAME: test
      #     DB_USER: root
      #     DB_PASS: toor
      #     DB_PORT: 3306
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install dependencies
          command: |
            apk add --no-cache \
              py-pip=9.0.0-r1
            pip install \
              docker-compose==1.12.0 \
              awscli==1.11.76
      - run:
          name: Build container images
          command: |
               docker-compose build
      # - run:
      #     name: Build image
      #     command: |
      #          cd app
      #          pwd
      #          docker build -t russcox/apptest .
      - run:
          name: Test containers
          command: |
               docker-compose up -d
      - run:
          name: Push image to registry
          command: |
              if [ "${CIRCLE_BRANCH}" == "master" ]; then
                 docker login -u $dh_user -p $dh_pass
                 docker tag russcox/app russcox/app:${CIRCLE_SHA1}
                 docker push russcox/app:${CIRCLE_SHA1}
              fi
  deploytest:
    docker:
      - image: docker
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: |
            apk add py-pip
            pip install terraform
      - run:
          name: Spin up test AWS environment
          command: |
            cd terraform
            terraform init
            terraform workspace select test
            terraform validate
            terraform plan
      - run:
          name: test ephemeral environment
          command: echo "run tests here"
      - run:
          name: Tear down test environment
          command: echo "run teardown here"
workflows:
  version: 2
  build-test:
    jobs:
      - build
      - deploytest:
          requires:
            - build
